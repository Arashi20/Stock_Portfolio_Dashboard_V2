{% extends "base.html" %}

{% block title %}Reports - Stock Dashboard{% endblock %}

{% block content %}
<div class="reports-page">
    <div class="page-header">
        <h1 class="reports-page-title">
            <i class="fas fa-file-alt"></i>
            Stock Reports
        </h1>
        <p class="page-description">Create and manage comprehensive stock analysis reports</p>
    </div>

    <div class="reports-container">
        <!-- Create Report Form -->
        <div class="reports-input-section">
            <div class="section-card">
                <h2 class="section-heading">
                    <i class="fas fa-plus-circle"></i>
                    Create New Report
                </h2>

                <form id="reportForm" method="POST" action="{{ url_for('create_report') }}">
                    <div class="input-grid">
                        <div class="form-group">
                            <label for="ticker">
                                <i class="fas fa-search"></i>
                                Ticker Symbol
                            </label>
                            <input 
                                type="text" 
                                id="ticker" 
                                name="ticker" 
                                class="form-control" 
                                placeholder="e.g., AAPL, MSFT, TSLA"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label for="title">
                                <i class="fas fa-heading"></i>
                                Report Title
                            </label>
                            <input 
                                type="text" 
                                id="title" 
                                name="title" 
                                class="form-control" 
                                placeholder="e.g., Q4 2025 Analysis"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label for="date">
                                <i class="fas fa-calendar"></i>
                                Report Date
                            </label>
                            <input 
                                type="date" 
                                id="date" 
                                name="date" 
                                class="form-control" 
                                value="{{ today }}"
                                required
                            >
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes">
                            <i class="fas fa-edit"></i>
                            Analysis & Notes
                        </label>
                        <div class="rich-text-editor">
                            <div class="editor-toolbar">
                                <button type="button" class="toolbar-btn" data-command="bold" title="Bold (Ctrl+B)">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-command="italic" title="Italic (Ctrl+I)">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-command="underline" title="Underline (Ctrl+U)">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <span class="toolbar-separator"></span>
                                <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="h2" title="Heading 2">
                                    <i class="fas fa-heading"></i> 2
                                </button>
                                <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="h3" title="Heading 3">
                                    <i class="fas fa-heading"></i> 3
                                </button>
                                <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="p" title="Paragraph">
                                    <i class="fas fa-paragraph"></i>
                                </button>
                                <span class="toolbar-separator"></span>
                                <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <span class="toolbar-separator"></span>
                                <button type="button" class="toolbar-btn" data-command="justifyLeft" title="Align Left">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-command="justifyCenter" title="Align Center">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-command="justifyRight" title="Align Right">
                                    <i class="fas fa-align-right"></i>
                                </button>
                                <span class="toolbar-separator"></span>
                                <button type="button" class="toolbar-btn" data-command="removeFormat" title="Clear Formatting">
                                    <i class="fas fa-eraser"></i>
                                </button>
                            </div>
                            <div id="editor-content" class="editor-content" contenteditable="true" data-placeholder="Write your comprehensive analysis, insights, and due diligence notes here..."></div>
                        </div>
                        <textarea 
                            id="notes" 
                            name="notes" 
                            style="display: none;"
                        ></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-large">
                            <i class="fas fa-save"></i>
                            Create Report
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reports Table -->
        {% if reports %}
        <div class="reports-table-section">
            <div class="section-card">
                <h2 class="section-heading">
                    <i class="fas fa-list"></i>
                    All Reports ({{ reports|length }})
                </h2>
                <div class="table-responsive">
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Title</th>
                                <th>Date</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in reports %}
                            <tr>
                                <td><strong>{{ report.ticker }}</strong></td>
                                <td>{{ report.title }}</td>
                                <td>{{ report.date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ report.date_created.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{{ url_for('view_report', report_id=report.id) }}" class="btn-action btn-view" title="View Report">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('edit_report', report_id=report.id) }}" class="btn-action btn-edit" title="Edit Report">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('delete_report', report_id=report.id) }}" style="display: inline;">
                                            <button type="button" class="btn-action btn-delete" title="Delete" onclick="showDeleteModal(this.form, 'Are you sure you wanna delete this report for {{ report.ticker }}?')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="section-card">
                <div class="empty-state-content">
                    <i class="fas fa-file-alt empty-state-icon"></i>
                    <h3>No reports yet</h3>
                    <p>Create your first stock analysis report using the form above.</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Rich Text Editor functionality
const editorContent = document.getElementById('editor-content');
const toolbarButtons = document.querySelectorAll('.toolbar-btn');

// Initialize toolbar buttons
toolbarButtons.forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        const command = this.dataset.command;
        const value = this.dataset.value || null;
        
        document.execCommand(command, false, value);
        editorContent.focus();
    });
});

// Sync editor content to hidden textarea on form submit
document.getElementById('reportForm').addEventListener('submit', function(e) {
    const htmlContent = editorContent.innerHTML;
    document.getElementById('notes').value = htmlContent;
    
    // Check if content is empty (only placeholder or whitespace)
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;
    const textContent = tempDiv.textContent || tempDiv.innerText || '';
    
    if (!textContent.trim()) {
        e.preventDefault();
        alert('Please enter some notes for your report.');
        return false;
    }
});

// Set today's date as default and pre-fill from URL parameters
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    // Pre-fill form from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const ticker = urlParams.get('ticker');
    
    if (ticker) {
        document.getElementById('ticker').value = ticker;
        document.getElementById('title').value = `DCF Analysis - ${ticker}`;
        
        // Build analysis summary for notes
        const fcf = urlParams.get('fcf');
        const shares = urlParams.get('shares');
        const growth5 = urlParams.get('growth_5yr');
        const growth610 = urlParams.get('growth_6_10yr');
        const terminal = urlParams.get('terminal');
        const discount = urlParams.get('discount');
        const dilution = urlParams.get('dilution');
        const intrinsic = urlParams.get('intrinsic');
        const targetPrice = urlParams.get('target_price');
        const currency = urlParams.get('currency') || '$';
        
        if (fcf && intrinsic) {
            const notesHTML = `<h2>DCF Analysis Summary for ${ticker}</h2>` +
                `<p><strong>Intrinsic Value: ${currency}${parseFloat(intrinsic).toFixed(2)} per share</strong></p>` +
                `<h3>Key Assumptions:</h3>` +
                `<ul>` +
                `<li>Free Cash Flow: ${parseFloat(fcf).toLocaleString()}</li>` +
                `<li>Shares Outstanding: ${parseFloat(shares).toLocaleString()}</li>` +
                `<li>Growth Rate (Years 1-5): ${growth5}%</li>` +
                `<li>Growth Rate (Years 6-10): ${growth610}%</li>` +
                `<li>Terminal Growth Rate: ${terminal}%</li>` +
                `<li>Discount Rate: ${discount}%</li>` +
                `<li>Share Dilution: ${dilution}%</li>` +
                `</ul>` +
                `<h3>Analysis Notes:</h3>` +
                `<p>[Add your detailed analysis, insights, and due diligence notes here...]</p>`;
            
            editorContent.innerHTML = notesHTML;
        } else if (targetPrice) {
            // Coming from wishlist - simpler note
            const notesHTML = `<h2>${ticker} Wishlist Analysis</h2>` +
                `<p><strong>Target Price: ${currency}${parseFloat(targetPrice).toFixed(2)}</strong></p>` +
                `<h3>Analysis Notes:</h3>` +
                `<p>[Add your detailed analysis, insights, and due diligence notes here...]</p>`;
            
            editorContent.innerHTML = notesHTML;
        }
    }
});
</script>

{% endblock %}
